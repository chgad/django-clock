{% extends 'shift/base.html' %}
{% load staticfiles i18n django_bootstrap_breadcrumbs format_duration %}

{% block extra_head %}{{ block.super }}
    <script type="text/javascript" src="{% static 'libraries/moment/js/moment-with-locales.min.js' %}"></script>
    <script type="text/javascript"
            src="{% static 'libraries/eonasdan-bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js' %}"></script>
    <link rel="stylesheet"
          href="{% static 'libraries/eonasdan-bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'libraries/datatables/css/buttons.dataTables.min.css' %}">

    <link rel="stylesheet" type="text/css" href="{% static 'libraries/datatables/css/select.bootstrap.min.css' %}">

    <link rel="stylesheet" href="{% static 'libraries/bootstrap-select/css/bootstrap-select.min.css' %}" media="screen"
          title="no title" charset="utf-8">

    <link rel="stylesheet" type="text/css" href="{% static 'libraries/datatables/css/dataTables.bootstrap.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'common/css/clock-datatables.css' %}">
{% endblock extra_head %}

{% block breadcrumbs %}{{ block.super }}
    {% breadcrumb month|date:"F Y" "shift_list" %}
{% endblock breadcrumbs %}

{% block container %}
    <h2>{% trans 'Shifts in' %} {{ month|date:"F Y" }}</h2>
    <div class="objectList-topbar row">
        <div class='col-sm-4'>
            <div class="form-group">
                <div class='input-group date' id='monthpicker'>
                    <input type='text' class="form-control"
                           placeholder="{% trans 'Change month...' %}"/>
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                </div>
            </div>
        </div>
        <div class="col-sm-4">
{#            {% if not previous_month or not shift %}#}
{#                <a class="btn btn-default disabled"><span#}
{#                        class="fa fa-chevron-left"></span> {{ previous_month|date:"F Y" }}#}
{#                </a>#}
{#            {% else %}#}
                <a href="{% url 'shift:archive_month_numeric' year=previous_month|date:"Y" month=previous_month|date:"m" %}"
                   class="btn btn-default"><span class="fa fa-chevron-left"></span> {{ previous_month|date:"F Y" }}
                </a>
{#            {% endif %}#}
{#            {% if not next_month or not shift %}#}
{#                <a class="btn btn-default disabled">{{ next_month|date:"F Y" }} <span#}
{#                        class="fa fa-chevron-right"></span></a>#}
{#            {% else %}#}
                <a href="{% url 'shift:archive_month_numeric' year=next_month|date:"Y" month=next_month|date:"m" %}"
                   class="btn btn-default">{{ next_month|date:"F Y" }} <span class="fa fa-chevron-right"></span></a>
{#            {% endif %}#}
        </div>
        <div class="col-sm-4">
            <a href="{% url 'shift:new' %}" class="btn btn-primary pull-right"><span
                    class="fa fa-plus"></span> {% trans 'Add new shift' %}</a>
        </div>
    </div>
    <table id="shift_table" class="table table-striped table-bordered display nowrap" cellspacing="0" width="100%">
        <thead>
        <tr>
            <th></th>
            <th></th>
            <th class="text-right">{% trans 'Shift No.' %}</th>
            <th class="text-right">{% trans 'Contract' %}</th>
            <th class="text-right">{% trans 'Shift started' %}</th>
            <th class="text-right">{% trans 'Shift finished' %}</th>
            <th class="text-right">{% trans 'Pause duration' %}</th>
            <th class="text-right">{% trans 'Shift duration' %}</th>
        </tr>
        </thead>
        <tfoot>
        <tr>
            <th></th>
            <th></th>
            <th class="text-right">{% trans 'Shift No.' %}</th>
            <th class="text-right">{% trans 'Contract' %}</th>
            <th class="text-right">{% trans 'Shift started' %}</th>
            <th class="text-right">{% trans 'Shift finished' %}</th>
            <th class="text-right">{% trans 'Pause duration' %}</th>
            <th class="text-right">{% trans 'Shift duration' %}</th>
        </tr>
        </tfoot>
        <tbody>
        {% for shift in object_list %}
            <tr id="{{ shift.pk }}">
                <td></td>
                <td></td>
                <td class="text-right">{{ forloop.counter }}</td>
                <td class="text-right">{{ shift.contract }}</td>
                <td class="text-right">{{ shift.shift_started }}</td>
                <td class="text-right">{{ shift.shift_finished }}</td>
                <td class="text-right">{{ shift.pause_duration|format_hhmm }}</td>
                <td class="text-right">{{ shift.shift_duration|format_hhmm }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% endblock container %}

{% block extra_js %}
    <script type="text/javascript" charset="utf8"
            src="{% static 'libraries/datatables/js/jquery.dataTables.js' %}"></script>
    <script type="text/javascript" charset="utf8"
            src="{% static 'libraries/datatables/js/dataTables.bootstrap.js' %}"></script>
    <script type="text/javascript" charset="utf8"
            src="{% static 'libraries/datatables/js/dataTables.responsive.min.js' %}"></script>
    <script type="text/javascript" charset="utf8"
            src="{% static 'libraries/datatables/js/responsive.bootstrap.min.js' %}"></script>
    <script type="text/javascript" charset="utf8"
            src="{% static 'libraries/datatables/js/dataTables.buttons.min.js' %}"></script>
    <script type="text/javascript" charset="utf8"
            src="{% static 'libraries/datatables/js/buttons.html5.min.js' %}"></script>
    <script type="text/javascript" charset="utf8"
            src="{% static 'libraries/datatables/js/dataTables.select.min.js' %}"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            var displayedMonth = false;
            var monthPicker = $('#monthpicker');
            // Check if the displayed month is equal to the current month. If not, set the default month to the displayed one.
            if ("{{ month|date:"Y-m" }}" != moment().format("YYYY-MM")) {
                displayedMonth = "{{ month|date:"Y-m" }}";
            }
            monthPicker.datetimepicker({
                'defaultDate': displayedMonth,
                'allowInputToggle': true,
                'format': 'MMMM YYYY',
                'focusOnShow': false,
                'viewMode': 'months',
                'enabledDates': [moment().format("YYYY-MM")]
            });

            // We want to change the page, when the date inside the picker was changed!
            monthPicker.on("dp.change", function (e) {
                // Grab the current date using moment.js
                var currentDate = moment();
                // If the displayed date is set, then we are not on the current date. Redirecting is OK!
                if (displayedMonth) {
                    window.location.href = "/shift/archive/" + e.date.format("YYYY") + "/" + e.date.format("MM");
                }
                // Otherwise the date is today. Check if the clicked date is the same as today. If not, redirect!
                if (e.date.format("YYYY-MM") != currentDate.format("YYYY-MM")) {
                    window.location.href = "/shift/archive/" + e.date.format("YYYY") + "/" + e.date.format("MM");
                }
            });
            // Hide the current value, so the placeholder is always shown!
            monthPicker.find(".form-control").val("");

            // Now the magic with the datatables comes into play.
            $('#shift_table').DataTable({
                dom: 'Bfrtip',
                responsive: true,
                {#        ajax: "static/json/shift_data.json",#}
                columns: [{ // Responsive control column
                    data: null,
                    defaultContent: '',
                    className: 'control',
                    orderable: false
                }, { // Checkbox select column
                    data: null,
                    defaultContent: '',
                    className: 'select-checkbox',
                    orderable: false
                }, {
                    data: "forloop.counter"
                }, {
                    data: "contract"
                }, {
                    data: "shift_started"
                }, {
                    data: "shift_finished"
                }, {
                    data: "pause_duration"
                }, {
                    data: "shift_duration"
                }],
                columnDefs: [{
                    responsivePriority: 1,
                    targets: 4
                }, {
                    responsivePriority: 2,
                    targets: -1
                }],
                order: [2, 'desc'],
                select: {
                    style: 'os',
                    selector: 'td.select-checkbox'
                },
                buttons: [],
                language: {
                    url: "{% static 'libraries/datatables/locale/de.json' %}"
                }
            });
        });

        $('#shift_table').on('click', 'tbody tr', function (evt) {

            // Handles the functionality around redirecting users to the clicked shift

            // Save element the click is performed on
            var target = $(evt.target);
            {#            console.log($(evt.target));#}
            {#            console.log(target.closest('td').index());#}

            var newPage;

            // Extremely quick-and-dirty method to get the whole click-thing running. There should be a better way!
            // This basically checks which element was clicked and then redirects to the edit page
            // The edit page should be /shift/<pk>/edit/
            // Every element is nested differently, but the <pk> is inside the original table <tr> ID-attribute
            // The first two cells (the expendable on mobile devices and the checkbox cell) are ignored.

            // If the row has a cell with a class .control and is visible
            if ($(this).find('td.control:visible').length) {
                // If clicked cell was not the control cell
                if (target.closest('td').index() > 1) {
                    newPage = target.parent().attr('id');
                    window.location.href = "/shift/" + newPage + "/edit/";
                }
                // Another check if we are clicking on the extra info shown on mobile devices!
            } else if (target.is('td.child')) {
                newPage = target.parent().prev().attr('id');
                window.location.href = "/shift/" + newPage + "/edit/";
            } else if (target.is("li")) {
                newPage = target.parent().parent().parent().prev().attr('id');
                window.location.href = "/shift/" + newPage + "/edit/";
            } else if (target.is('span.dtr-data') || target.is('span.dtr-title')) {
                newPage = target.parent().parent().parent().parent().prev().attr('id');
                window.location.href = "/shift/" + newPage + "/edit/";
                // If .control class is not visible, we're obviously on a bigger screen.
                // Check if we are clicking on the .select-checkbox td or any other!
            } else if (target.closest('td').index() > 1) {
                newPage = target.parent().attr('id');
                window.location.href = "/shift/" + newPage + "/edit/";
            }
        });
    </script>
{% endblock extra_js %}
